<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"  content="width=device-width, initial-scale=1" />
  <title>üìà Orderbook Dashboard</title>

  <!-- Darkly theme -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.1/dist/darkly/bootstrap.min.css" rel="stylesheet"/>
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- DataTables CSS -->
  <link href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css" rel="stylesheet"/>

  <style>
    body { padding-top: 6rem; background: #121417; color: #e1e1e1; }
    .form-section {
      background: #1c2128; padding:1.5rem; border-radius:.5rem;
      box-shadow:0 .125rem .25rem rgba(0,0,0,.5);
    }
    #resultSection { margin-top:2rem; }
    .field-group { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }
    .field-group .btn { font-size:.85rem; padding:.375rem .75rem; }

    /* dark inputs */
    .form-control, .form-select {
      background:#2a2f36; color:#e1e1e1; border:1px solid #444;
    }
    .form-control:focus, .form-select:focus {
      box-shadow:0 0 0 .25rem rgba(90,95,102,.25);
    }

    /* DataTables dark tweaks */
    .dataTables_length select, .dataTables_filter input {
      background:#2a2f36!important; color:#e1e1e1!important; border:1px solid #444!important;
    }
    .dataTables_length label, .dataTables_filter label { color:#e1e1e1; }
    table.dataTable thead th {
      background:#2a2f36!important; color:#e1e1e1!important; border-bottom:1px solid #444!important;
    }
    .table-striped>tbody>tr:nth-of-type(odd) {
      --bs-table-accent-bg:#1c2128; color:#e1e1e1;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fa-solid fa-chart-line"></i> Orderbook Dashboard
      </a>
    </div>
  </nav>

  <main class="container-fluid px-4">

    <!-- Controls -->
    <section class="form-section">
      <form id="cmdForm" class="row gx-3 gy-4 align-items-end text-light">

        <!-- Action -->
        <div class="col-md-2">
          <label for="action" class="form-label text-light">Action</label>
          <select id="action" name="action" class="form-select form-select-dark">
            <option value="compile">üîß Compile</option>
            <option value="run">‚ñ∂Ô∏è Process Files</option>
            <option value="query" selected>üîç Query</option>
            <option value="test">‚úîÔ∏è Test</option>
            <option value="clean">üßπ Clean</option>
          </select>
        </div>

        <!-- Query Params -->
        <div id="queryParams" class="col-md-10 row gx-3 gy-4">

          <!-- Symbols -->
          <div class="col-lg-2 col-md-4">
            <label class="form-label text-light">Symbols</label>
            <select name="symbols" class="form-select form-select-dark">
              <option selected>SCH</option>
              <option>SCS</option>
              <option>ALL</option>
            </select>
          </div>

          <!-- Start TS -->
          <div class="col-lg-3 col-md-4">
            <label class="form-label text-light">Start TS</label>
            <input name="start_ts" class="form-control form-control-dark" value="{{ start_ts }}">
          </div>

          <!-- End TS -->
          <div class="col-lg-3 col-md-4">
            <label class="form-label text-light">End TS</label>
            <input name="end_ts" class="form-control form-control-dark" value="{{ end_ts }}">
          </div>

          <!-- Fields -->
          <div class="col-lg-4 col-md-12">
            <label class="form-label text-light">Fields <small class="text-muted">(toggle on/off)</small></label>
            <div class="field-group" role="group">
              <!-- all 22 buttons -->
              <button type="button" class="btn btn-outline-primary field-btn" data-field="symbol">symbol</button>
              <button type="button" class="btn btn-outline-primary field-btn" data-field="epoch">epoch</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid1q">bid1q</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid1p">bid1p</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid2q">bid2q</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid2p">bid2p</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid3q">bid3q</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid3p">bid3p</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid4q">bid4q</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid4p">bid4p</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid5q">bid5q</button>
              <button type="button" class="btn btn-outline-secondary field-btn" data-field="bid5p">bid5p</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask1q">ask1q</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask1p">ask1p</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask2q">ask2q</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask2p">ask2p</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask3q">ask3q</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask3p">ask3p</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask4q">ask4q</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask4p">ask4p</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask5q">ask5q</button>
              <button type="button" class="btn btn-outline-info field-btn" data-field="ask5p">ask5p</button>
              <button type="button" class="btn btn-outline-success field-btn" data-field="lastTradePrice">lastTradePrice</button>
              <button type="button" class="btn btn-outline-success field-btn" data-field="lastTradeQuantity">lastTradeQuantity</button>
            </div>
          </div>

        </div>

        <!-- Execute -->
        <div class="col-12 text-end">
          <button id="submitBtn" type="submit" class="btn btn-success px-4">
            <i class="fa-solid fa-play me-1"></i> Execute
          </button>
        </div>
      </form>
    </section>

    <!-- Results -->
    <section id="resultSection">
      <div class="card bg-dark border-secondary">
        <div class="card-header bg-secondary text-light d-flex align-items-center">
          <i class="fa-solid fa-terminal me-1"></i> Output
          <small id="elapsedTime" class="text-muted ms-3"></small>
        </div>
        <div class="card-body py-3">
          <div class="table-responsive" id="tableWrapper">
            <table id="resultTable" class="table table-dark table-striped table-hover w-100"></table>
          </div>
          <pre id="rawOutput" class="mt-3 text-monospace text-light d-none"></pre>
        </div>
      </div>
    </section>

  </main>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>

  <script>
    const form      = $("#cmdForm");
    const rawOutput = $("#rawOutput");
    let dataTable   = null;

    // show/hide query inputs
    form.find("[name=action]")
      .on("change", e => $("#queryParams").toggle(e.target.value==="query"))
      .trigger("change");

    // pre-select defaults
    const defaults = [
      "symbol","epoch","lastTradeQuantity","lastTradePrice",
      "bid1p","bid1q","ask1p","ask1q","bid2p","bid2q","ask2p","ask2q"
    ];
    $(".field-btn").each((_,b)=>{
      const f=b.dataset.field,$b=$(b);
      if(defaults.includes(f)){
        $b.addClass("active")
          .removeClass("btn-outline-primary btn-outline-secondary btn-outline-info btn-outline-success")
          .addClass({
            symbol:"btn-primary",epoch:"btn-primary",
            bid1q:"btn-secondary",bid1p:"btn-secondary",bid2q:"btn-secondary",bid2p:"btn-secondary",
            bid3q:"btn-secondary",bid3p:"btn-secondary",bid4q:"btn-secondary",bid4p:"btn-secondary",
            bid5q:"btn-secondary",bid5p:"btn-secondary",
            ask1q:"btn-info",ask1p:"btn-info",ask2q:"btn-info",ask2p:"btn-info",
            ask3q:"btn-info",ask3p:"btn-info",ask4q:"btn-info",ask4p:"btn-info",
            ask5q:"btn-info",ask5p:"btn-info",
            lastTradePrice:"btn-success",lastTradeQuantity:"btn-success"
          }[f]);
      }
    });

    // toggle behavior
    $(".field-btn").on("click", function(){
      const $b=$(this),f=$b.data("field");
      const outline={
        symbol:"btn-outline-primary",epoch:"btn-outline-primary",
        bid1q:"btn-outline-secondary",bid1p:"btn-outline-secondary",bid2q:"btn-outline-secondary",bid2p:"btn-outline-secondary",
        bid3q:"btn-outline-secondary",bid3p:"btn-outline-secondary",bid4q:"btn-outline-secondary",bid4p:"btn-outline-secondary",
        bid5q:"btn-outline-secondary",bid5p:"btn-outline-secondary",
        ask1q:"btn-outline-info",ask1p:"btn-outline-info",ask2q:"btn-outline-info",ask2p:"btn-outline-info",
        ask3q:"btn-outline-info",ask3p:"btn-outline-info",ask4q:"btn-outline-info",ask4p:"btn-outline-info",
        ask5q:"btn-outline-info",ask5p:"btn-outline-info",
        lastTradePrice:"btn-outline-success",lastTradeQuantity:"btn-outline-success"
      }[f];
      const solid=outline.replace("outline-","");
      if($b.hasClass("active")){
        $b.removeClass(`active ${solid}`).addClass(outline);
      } else {
        $b.addClass(`active ${solid}`).removeClass(outline);
      }
    });

    // form submit
    form.on("submit", async ev=>{
      ev.preventDefault();
      rawOutput.addClass("d-none").text("");
      $("#elapsedTime").text("");

      // spinner
      const sb=$("#submitBtn");
      sb.prop("disabled",true)
        .html('<i class="fa-solid fa-spinner fa-spin me-1"></i> Running‚Ä¶');

      // tear down old table
      if(dataTable){ dataTable.destroy(); dataTable=null; }
      $("#tableWrapper").html(
        `<table id="resultTable" class="table table-dark table-striped table-hover w-100"></table>`
      );

      // build & send
      const formData=new FormData(ev.target);
      if($("#action").val()==="query"){
        const sel=$(".field-btn.active").map((i,b)=>b.dataset.field).get().join(",");
        formData.set("fields",sel);
      }
      const res=await fetch("/run",{method:"POST",body:formData});
      const {output,elapsed_ms}=await res.json();

      // restore button + show time
      sb.prop("disabled",false)
        .html('<i class="fa-solid fa-play me-1"></i> Execute');
      if(elapsed_ms!==undefined){
        $("#elapsedTime").text(`‚è± ${elapsed_ms} ms`);
      }

      // render results or raw
      const lines=output.trim().split(/\r?\n/);
      if(lines.length>1 && lines[0].includes(",")){
        const headers=lines.shift().split(","),rows=lines.map(l=>l.split(","));
        let thead="<thead class='table-light'><tr>";
        headers.forEach(h=>thead+=`<th>${h}</th>`);
        thead+="</tr></thead>";
        $("#resultTable").append(thead).show();
        dataTable=$("#resultTable").DataTable({
          destroy:true,data:rows,
          columns:headers.map(h=>({title:h})),
          paging:true,searching:true,info:false,autoWidth:false
        });
      } else {
        rawOutput.removeClass("d-none").text(output);
      }
    });
  </script>
</body>
</html>
